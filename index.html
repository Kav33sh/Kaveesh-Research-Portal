<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wave Impedance Haptics — Portfolio</title>
<style>
  :root{
    --bg:#0b1222; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
    --accent:#22d3ee; --accent2:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --br:#1f2937;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#0b1222,#0a0f1a);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--br);}
  .bar{max-width:1200px;margin:0 auto;display:flex;gap:16px;align-items:center;padding:12px 16px}
  h1{font-size:18px;margin:0;color:#e2e8f0}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .tab{border:1px solid var(--br);color:var(--ink);background:#0b1324;border-radius:999px;padding:8px 12px;cursor:pointer;font-size:14px}
  .tab.active{background:var(--accent);color:#0a0f1a;border-color:transparent}
  main{max-width:1200px;margin:20px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--br);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--br);background:#0b1324;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#12203a}
  .btn.primary{background:var(--accent);color:#08101c;border-color:transparent}
  .btn.danger{border-color:#7f1d1d;background:#220a0a}
  input[type="text"], input[type="url"], textarea{width:100%;background:#0b1324;border:1px solid var(--br);border-radius:10px;color:var(--ink);padding:10px}
  textarea{min-height:100px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1.1fr .9fr}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1324;border:1px solid var(--br);border-radius:999px;padding:6px 10px;color:#94a3b8;font-size:12px}
  .muted{color:#94a3b8;font-size:13px}
  .hidden{display:none}
  .post{background:#0b1324;border:1px solid var(--br);border-radius:12px;padding:12px;display:grid;gap:8px}
  .post img{max-width:100%;border-radius:10px;border:1px solid #223047}
</style>

<!-- Markdown renderer for post bodies -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Supabase client (your project) -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const PROJECT_URL = "https://vczxjeoairhytagzpxkb.supabase.co";
  const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjenhqZW9haXJoeXRhZ3pweGtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MjYwMzIsImV4cCI6MjA3MTIwMjAzMn0.FRv4USQT8RcJAjstfLkLfWbwO13gPcFDB2R23hNxLkU";
  window.supabase = createClient(PROJECT_URL, ANON_KEY);
</script>
</head>
<body>
<header>
  <div class="bar">
    <h1>Kaveesh Kanagaraj - Research Portal</h1>
    <nav id="tabs">
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="learnings">Learnings</button>
      <button class="tab" data-tab="checklist">Checklist</button>
      <button class="tab" data-tab="prof">Prof. Katsura</button>
      <button class="tab" data-tab="models">Models</button>
      <button class="tab" data-tab="articles">Articles</button>
    </nav>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Home</h2>
      <div id="authBar" class="row">
        <button class="btn" id="login">Sign in with GitHub</button>
        <button class="btn" id="logout" style="display:none">Logout</button>
      </div>
    </div>

    <div class="grid two">
      <div>
        <div class="card">
          <h3>Dashboard</h3>
          <label class="pill">Hero Title</label>
          <input id="homeTitle" type="text" placeholder="e.g., My Journey in Control Engineering">
          <label class="pill">Hero Subtitle</label>
          <input id="homeSubtitle" type="text" placeholder="e.g., Building toward wave impedance haptics">
          <label class="pill">About</label>
          <textarea id="homeAbout" placeholder="Short summary about your research and interests..."></textarea>
          <div class="row">
            <button class="btn primary" id="saveHome">Save Home</button>
            <span class="muted" id="homeSaved"></span>
          </div>
        </div>

        <div class="card">
          <h3>Posts</h3>
          <p class="muted">Public feed from Supabase (anyone can view). Sign in to create a new post with an image.</p>
          <div id="postList" class="grid" style="gap:10px"></div>

          <!-- New Post -->
          <div id="newPost" class="card hidden" style="margin-top:12px">
            <h3>New Post</h3>
            <input id="pTitle" type="text" placeholder="Title">
            <textarea id="pBody" placeholder="Markdown content..."></textarea>
            <input id="pImage" type="file" accept="image/*">
            <div class="row">
              <button class="btn primary" id="publish">Publish</button>
            </div>
            <div class="muted" id="pubMsg"></div>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div>
        <div class="card">
          <h3>Notes</h3>
          <p class="muted">Private notes saved in your browser.</p>
          <textarea id="homeNotes" placeholder="Write your study notes..."></textarea>
        </div>
      </div>
    </div>
  </section>

  <!-- LEARNINGS -->
  <section id="learnings" class="card hidden">
    <h2>Learnings (Notebook)</h2>
    <div class="row" style="gap:6px;margin:8px 0">
      <button class="btn" data-cmd="bold"><b>B</b></button>
      <button class="btn" data-cmd="italic"><i>I</i></button>
      <button class="btn" data-cmd="underline"><u>U</u></button>
      <button class="btn" id="h1">H1</button>
      <button class="btn" id="h2">H2</button>
      <button class="btn" id="bul">• List</button>
      <button class="btn" id="img">Insert Image</button>
      <button class="btn primary" id="saveNote">Save</button>
      <span class="muted" id="noteSaved"></span>
    </div>
    <div id="editor" class="editor" contenteditable="true"></div>
  </section>

  <!-- CHECKLIST -->
  <section id="checklist" class="card hidden">
    <h2>Checklist</h2>
    <div id="checkContainer" class="grid" style="gap:10px"></div>
    <div class="row" style="margin-top:10px">
      <input id="newItem" type="text" placeholder="Add a custom checklist item...">
      <button class="btn" id="addItem">Add</button>
      <button class="btn" id="resetChecklist">Reset Defaults</button>
    </div>
  </section>

  <!-- PROF. KATSURA -->
  <section id="prof" class="card hidden">
    <h2>Prof. Katsura — Lab & Papers</h2>
    <div class="grid" id="profLinks" style="gap:8px"></div>
    <div class="card" style="margin-top:16px">
      <h3>Add Link</h3>
      <div class="row">
        <input id="linkTitle" type="text" placeholder="Title (e.g., Wave Dynamics paper)">
        <input id="linkURL" type="url" placeholder="https://...">
        <button class="btn" id="addLink">Add</button>
      </div>
    </div>
  </section>

  <!-- MODELS -->
  <section id="models" class="card hidden">
    <h2>Models & Demos</h2>
    <div id="modelList" class="grid" style="gap:8px"></div>
    <div class="card" style="margin-top:16px">
      <h3>Add Model</h3>
      <div class="grid two">
        <input id="modelTitle" type="text" placeholder="e.g., MCS Python Simulation">
        <input id="modelURL" type="url" placeholder="https://github.com/...">
      </div>
      <textarea id="modelDesc" placeholder="Short description..."></textarea>
      <div class="row">
        <button class="btn" id="addModel">Add Model</button>
      </div>
    </div>
  </section>

  <!-- ARTICLES -->
  <section id="articles" class="card hidden">
    <h2>Articles & Papers (Related Work)</h2>
    <div id="articleList" class="grid" style="gap:8px"></div>
    <div class="card" style="margin-top:16px">
      <h3>Add Article</h3>
      <div class="grid two">
        <input id="articleTitle" type="text" placeholder="Paper title">
        <input id="articleURL" type="url" placeholder="https://doi.org/...">
      </div>
      <textarea id="articleNotes" placeholder="Why is this relevant?"></textarea>
      <div class="row">
        <button class="btn" id="addArticle">Add Article</button>
      </div>
    </div>
  </section>
</main>

<footer>
  Local notes are private in your browser. Public posts & images are served via Supabase so anyone can view them.
</footer>

<script>
// Tabs
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>t.addEventListener('click', ()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(t.dataset.tab).classList.remove('hidden');
  localStorage.setItem('activeTab', t.dataset.tab);
}));
const savedTab = localStorage.getItem('activeTab');
if(savedTab){ tabs.forEach(t=>{ if(t.dataset.tab===savedTab){ t.click(); }}); }

// Home fields + notes
const homeTitle = document.getElementById('homeTitle');
const homeSubtitle = document.getElementById('homeSubtitle');
const homeAbout = document.getElementById('homeAbout');
const homeSaved = document.getElementById('homeSaved');
const homeNotes = document.getElementById('homeNotes');
(function loadHome(){
  homeTitle.value = localStorage.getItem('homeTitle') || "My Journey in Control Engineering";
  homeSubtitle.value = localStorage.getItem('homeSubtitle') || "Building toward wave impedance-based haptics for VR and teleoperation";
  homeAbout.value = localStorage.getItem('homeAbout') || "";
  homeNotes.value = localStorage.getItem('homeNotes') || "";
})();
document.getElementById('saveHome').onclick = ()=>{
  localStorage.setItem('homeTitle', homeTitle.value);
  localStorage.setItem('homeSubtitle', homeSubtitle.value);
  localStorage.setItem('homeAbout', homeAbout.value);
  homeSaved.textContent = "Saved ✓"; setTimeout(()=>homeSaved.textContent="",1200);
};
homeNotes.addEventListener('input', ()=> localStorage.setItem('homeNotes', homeNotes.value));

// Learnings editor
const editor = document.getElementById('editor');
const noteSaved = document.getElementById('noteSaved');
(function loadNote(){
  editor.innerHTML = localStorage.getItem('noteHTML') || "<h2>Week 1 — Foundations</h2><ul><li>Reviewed bilateral teleoperation and wave variables.</li><li>Built MCS demo & plotted RMSE.</li></ul>";
})();
document.querySelectorAll('[data-cmd]').forEach(btn=>btn.addEventListener('click', ()=>document.execCommand(btn.dataset.cmd,false,null)));
document.getElementById('h1').onclick = ()=> document.execCommand('formatBlock', false, 'h1');
document.getElementById('h2').onclick = ()=> document.execCommand('formatBlock', false, 'h2');
document.getElementById('bul').onclick = ()=> document.execCommand('insertUnorderedList', false, null);
document.getElementById('img').onclick = ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>document.execCommand('insertImage',false,r.result); r.readAsDataURL(f); };
  i.click();
};
document.getElementById('saveNote').onclick = ()=>{ localStorage.setItem('noteHTML', editor.innerHTML); noteSaved.textContent="Saved ✓"; setTimeout(()=>noteSaved.textContent="",1200); };

// Checklist
const DEFAULT_ITEMS = [
  "Review wave-variable theory for passivity over delays",
  "Study bilateral teleoperation architectures (position-force, 4-ch)",
  "Derive wave impedance mapping for 1-DOF mass-spring-damper",
  "Understand infinite-order modeling / abstraction (Katsura lab)",
  "Implement PD/LQR on a 2-link arm (sim)",
  "Build Disturbance Observer (DOB) for motor/arm with friction)",
  "Add modal-space separation for flexible dynamics",
  "Implement time-delay blocks; analyze stability margins",
  "Design passivity observer/passivity controller (PO/PC)",
  "Implement energy tank / virtual energy shaping",
  "Construct wave-variable wrapped teleop loop (master-slave)",
  "Design haptic rendering of virtual wall (impedance control)",
  "Simulate aerospace docking contact with force thresholds",
  "Implement motion-copying system (MCS) [COMPLETED]"
];
const checkContainer = document.getElementById('checkContainer');
function loadChecklist(){
  let items = JSON.parse(localStorage.getItem('checklist')||'null');
  if(!items) { items = DEFAULT_ITEMS.map(t=>({t,done:/motion-copying/i.test(t)})); localStorage.setItem('checklist', JSON.stringify(items)); }
  renderChecklist(items);
}
function renderChecklist(items){
  checkContainer.innerHTML = "";
  items.forEach((it,idx)=>{
    const div = document.createElement('div'); div.className='check-item'+(it.done?' done':'');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!it.done;
    const title = document.createElement('div'); title.className='check-title'; title.textContent=it.t;
    if(it.done) title.classList.add('strike');
    cb.onchange = ()=>{ it.done = cb.checked; const all = JSON.parse(localStorage.getItem('checklist')); all[idx]=it; localStorage.setItem('checklist', JSON.stringify(all)); renderChecklist(all); };
    const del = document.createElement('button'); del.className='btn danger'; del.textContent='Remove';
    del.onclick = ()=>{ const all = JSON.parse(localStorage.getItem('checklist')); all.splice(idx,1); localStorage.setItem('checklist', JSON.stringify(all)); renderChecklist(all); };
    div.appendChild(cb); const inner = document.createElement('div'); inner.style.flex='1'; inner.appendChild(title); div.appendChild(inner); div.appendChild(del);
    checkContainer.appendChild(div);
  });
}
document.getElementById('addItem').onclick = ()=>{ const v=document.getElementById('newItem').value.trim(); if(!v) return; const all=JSON.parse(localStorage.getItem('checklist')); all.push({t:v,done:false}); localStorage.setItem('checklist', JSON.stringify(all)); document.getElementById('newItem').value=""; renderChecklist(all); };
document.getElementById('resetChecklist').onclick = ()=>{ localStorage.removeItem('checklist'); loadChecklist(); };
loadChecklist();

// Prof links
const profLinks = document.getElementById('profLinks');
(function(){
  const DEFAULT_LINKS = [
    {title:"Katsura Laboratory (Keio) — Homepage", url:"https://www.katsura.sd.keio.ac.jp/"},
    {title:"Keio Researcher Database — Seiichiro Katsura", url:"https://k-ris.keio.ac.jp/html/100011690_en.html"},
    {title:"Research Introduction Video", url:"https://www.youtube.com/watch?v=Q3fUgDhkl0g"}
  ];
  const list = JSON.parse(localStorage.getItem('profLinks')||'null') || DEFAULT_LINKS;
  localStorage.setItem('profLinks', JSON.stringify(list));
  renderLinks(list);
})();
function renderLinks(list){
  profLinks.innerHTML=""; list.forEach((ln,idx)=>{
    const row = document.createElement('div'); row.className='link-item';
    const a = document.createElement('a'); a.href=ln.url; a.target='_blank'; a.rel='noopener'; a.textContent = ln.title;
    const del = document.createElement('button'); del.className='btn danger'; del.textContent='Remove';
    del.onclick = ()=>{ const all = JSON.parse(localStorage.getItem('profLinks')); all.splice(idx,1); localStorage.setItem('profLinks', JSON.stringify(all)); renderLinks(all); };
    row.appendChild(a); row.appendChild(del); profLinks.appendChild(row);
  });
}

// Models
const modelList = document.getElementById('modelList');
(function(){
  const list = JSON.parse(localStorage.getItem('models')||'null') || [
    {title:"MCS Python Simulation", url:"#", desc:"Mouse → 2-link arm, PD + delay injection, RMSE & max error."},
    {title:"Web MCS Demo", url:"#", desc:"HTML/JS demo: record → IK → PD replay → plots."}
  ];
  localStorage.setItem('models', JSON.stringify(list));
  renderModels(list);
})();
function renderModels(list){
  modelList.innerHTML=""; list.forEach((m,idx)=>{
    const row = document.createElement('div'); row.className='link-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${m.title}</div><div class="muted">${m.desc}</div>`;
    const right = document.createElement('div'); const a = document.createElement('a'); a.href=m.url; a.target="_blank"; a.textContent = "Open";
    const del = document.createElement('button'); del.className='btn danger'; del.textContent='Remove'; del.style.marginLeft='8px';
    del.onclick = ()=>{ const all = JSON.parse(localStorage.getItem('models')); all.splice(idx,1); localStorage.setItem('models', JSON.stringify(all)); renderModels(all); };
    right.appendChild(a); right.appendChild(del); row.appendChild(left); row.appendChild(right); modelList.appendChild(row);
  });
}
document.getElementById('addModel').onclick = ()=>{ const t=document.getElementById('modelTitle').value.trim(); const u=document.getElementById('modelURL').value.trim(); const d=document.getElementById('modelDesc').value.trim(); if(!t) return;
  const all = JSON.parse(localStorage.getItem('models')); all.unshift({title:t, url:u||"#", desc:d||""}); localStorage.setItem('models', JSON.stringify(all));
  document.getElementById('modelTitle').value=""; document.getElementById('modelURL').value=""; document.getElementById('modelDesc').value=""; renderModels(all);
};

// Articles
const articleList = document.getElementById('articleList');
(function(){
  const list = JSON.parse(localStorage.getItem('articles')||'null') || [
    {title:"Bilateral teleoperation with wave variables — notes", url:"#", notes:"Passivity guarantee via energy variables."},
    {title:"Disturbance Observers in Mechatronics — overview", url:"#", notes:"DOB for friction/load disturbance rejection."}
  ];
  localStorage.setItem('articles', JSON.stringify(list));
  renderArticles(list);
})();
function renderArticles(list){
  articleList.innerHTML=""; list.forEach((a,idx)=>{
    const row = document.createElement('div'); row.className='link-item';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${a.title}</div><div class="muted">${a.notes||""}</div>`;
    const right = document.createElement('div'); const link=document.createElement('a'); link.href=a.url; link.target="_blank"; link.textContent="Open";
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='Remove'; del.style.marginLeft='8px';
    del.onclick = ()=>{ const all = JSON.parse(localStorage.getItem('articles')); all.splice(idx,1); localStorage.setItem('articles', JSON.stringify(all)); renderArticles(all); };
    right.appendChild(link); right.appendChild(del); row.appendChild(left); row.appendChild(right); articleList.appendChild(row);
  });
}
document.getElementById('addArticle').onclick = ()=>{ const t=document.getElementById('articleTitle').value.trim(); const u=document.getElementById('articleURL').value.trim(); const n=document.getElementById('articleNotes').value.trim(); if(!t || !u) return;
  const all=JSON.parse(localStorage.getItem('articles')); all.unshift({title:t, url:u, notes:n}); localStorage.setItem('articles', JSON.stringify(all));
  document.getElementById('articleTitle').value=""; document.getElementById('articleURL').value=""; document.getElementById('articleNotes').value=""; renderArticles(all);
};
</script>

<!-- Supabase: Auth + Posts + Image Upload (BUCKET: images) -->
<script type="module">
  const BUCKET_NAME = "images";
  const loginBtn  = document.getElementById('login');
  const logoutBtn = document.getElementById('logout');
  const newPostEl = document.getElementById('newPost');
  const postList  = document.getElementById('postList');
  const RETURN_TO = "https://kav33sh.github.io/Kaveesh-Research-Portal/";

  // Auth state
  supabase.auth.onAuthStateChange((_event, session) => {
    const loggedIn = !!session;
    loginBtn.style.display  = loggedIn ? 'none' : 'inline-block';
    logoutBtn.style.display = loggedIn ? 'inline-block' : 'none';
    newPostEl.classList.toggle('hidden', !loggedIn);
  });

  loginBtn.onclick = async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'github',
      options: { redirectTo: RETURN_TO }
    });
    if (error) { alert(`Login error: ${error.message}`); console.error(error); }
  };
  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    location.href = RETURN_TO;
  };

  // Load posts
  async function loadPosts(){
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false });

    if(error){
      postList.innerHTML = "<div class='muted'>Failed to load posts.</div>";
      console.error(error);
      return;
    }
    postList.innerHTML = "";
    for(const p of data){
      const card = document.createElement('div');
      card.className = 'post';
      const title = p.title || "Post";
      const when = new Date(p.created_at).toLocaleString();
      const imgTag = p.image_url ? `<img src="${p.image_url}" alt="post image">` : "";
      const bodyHTML = window.marked ? marked.parse(p.body_md || "") : (p.body_md || "");
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${title}</div>
          <div class="muted" style="font-size:12px">${when}</div>
        </div>
        ${imgTag}
        <div class="post-body">${bodyHTML}</div>
      `;
      postList.appendChild(card);
    }
  }

  // Upload image to 'images' bucket
  async function uploadImage(file){
    if(!file) return null;
    const path = `posts/${Date.now()}_${file.name}`;
    const { data, error } = await supabase
      .storage
      .from(BUCKET_NAME)
      .upload(path, file, {
        upsert: false,
        cacheControl: "3600",
        contentType: file.type || "application/octet-stream"
      });
    if(error){
      console.error("Storage upload error:", error);
      const msg = document.getElementById('pubMsg');
      if (msg) msg.textContent = `Upload error: ${error.message || JSON.stringify(error)}`;
      return null;
    }
    const { data: pub } = supabase.storage.from(BUCKET_NAME).getPublicUrl(path);
    return pub.publicUrl;
  }

  // Publish new post
  document.getElementById('publish').onclick = async ()=>{
    const title = document.getElementById('pTitle').value.trim();
    const body  = document.getElementById('pBody').value.trim();
    const file  = document.getElementById('pImage').files[0];
    const msg   = document.getElementById('pubMsg');

    if(!title || !body){ msg.textContent = "Title and content required."; return; }

    const { data: { user } } = await supabase.auth.getUser();
    if(!user){ msg.textContent = "Please sign in first."; return; }

    let image_url = null;
    if(file){
      image_url = await uploadImage(file);
      if(!image_url){ return; } // error message already shown
    }

    const { error } = await supabase.from('posts').insert({
      author: user.id, title, body_md: body, image_url
    });
    if(error){ msg.textContent = `Publish failed: ${error.message}`; console.error(error); return; }

    msg.textContent = "Published ✓";
    document.getElementById('pTitle').value = "";
    document.getElementById('pBody').value  = "";
    document.getElementById('pImage').value = "";
    loadPosts();
  };

  loadPosts();
</script>
</body>
</html>
