<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wave Impedance Haptics — Portfolio</title>
<style>
  :root{
    --bg:#0b1222; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
    --accent:#22d3ee; --accent2:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --br:#1f2937;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#0b1222,#0a0f1a);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.8);backdrop-filter:blur(8px);border-bottom:1px solid var(--br);}
  .bar{max-width:1200px;margin:0 auto;display:flex;gap:16px;align-items:center;padding:12px 16px}
  h1{font-size:18px;margin:0;color:#e2e8f0}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .tab{border:1px solid var(--br);color:var(--ink);background:#0b1324;border-radius:999px;padding:8px 12px;cursor:pointer;font-size:14px}
  .tab.active{background:var(--accent);color:#0a0f1a;border-color:transparent}
  main{max-width:1200px;margin:20px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--br);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--br);background:#0b1324;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#12203a}
  .btn.primary{background:var(--accent);color:#08101c;border-color:transparent}
  .btn.danger{border-color:#7f1d1d;background:#220a0a}
  input[type="text"], input[type="url"], textarea{width:100%;background:#0b1324;border:1px solid var(--br);border-radius:10px;color:var(--ink);padding:10px}
  textarea{min-height:100px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1.1fr .9fr}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1324;border:1px solid var(--br);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
  .muted{color:var(--muted);font-size:13px}
  .hidden{display:none}
  /* Editor */
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .editor{background:#0b1324;border:1px dashed #334155;border-radius:12px;padding:12px;min-height:360px}
  .editor:focus{outline:2px solid var(--accent)}
  /* File list */
  .file{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--br);border-radius:10px;padding:8px 10px;background:#0b1324}
  .file i{font-style:normal;color:var(--muted);font-size:12px}
  /* Checklist */
  .check-item{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--br);border-radius:10px;padding:10px;background:#0b1324}
  .check-item.done{border-color:#12422a;background:#0c1f16}
  .check-title{font-weight:600}
  .strike{text-decoration:line-through;color:#9ca3af}
  /* Link list */
  .link-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--br);border-radius:10px;padding:10px;background:#0b1324}
  a{color:var(--accent2);text-decoration:none}
  a:hover{text-decoration:underline}
  footer{max-width:1200px;margin:20px auto;padding:0 16px 40px;color:#93a3b8;font-size:12px}
  /* Posts */
  .post{background:#0b1324;border:1px solid var(--br);border-radius:12px;padding:12px;display:grid;gap:8px}
  .post img{max-width:100%;border-radius:10px;border:1px solid #223047}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--br);background:#0b1324;color:#cbd5e1}
</style>

<!-- Marked for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Supabase client (creates window.supabase) -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const PROJECT_URL = "https://vczxjeoairhytagzpxkb.supabase.co";
  const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjenhqZW9haXJoeXRhZ3pweGtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MjYwMzIsImV4cCI6MjA3MTIwMjAzMn0.FRv4USQT8RcJAjstfLkLfWbwO13gPcFDB2R23hNxLkU";
  window.supabase = createClient(PROJECT_URL, ANON_KEY);
</script>
</head>
<body>
<header>
  <div class="bar">
    <h1>Kaveesh Kanagaraj - Research Portal</h1>
    <nav id="tabs">
      <button class="tab active" data-tab="home">Home</button>
      <button class="tab" data-tab="learnings">Learnings</button>
      <button class="tab" data-tab="checklist">Checklist</button>
      <button class="tab" data-tab="prof">Prof. Katsura</button>
      <button class="tab" data-tab="models">Models</button>
      <button class="tab" data-tab="articles">Articles</button>
    </nav>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Home</h2>
      <div id="authBar" class="row">
        <button class="btn" id="login">Sign in with GitHub</button>
        <button class="btn" id="logout" style="display:none">Logout</button>
      </div>
    </div>

    <div class="grid two">
      <!-- Left column -->
      <div>
        <div class="card">
          <h3>Dashboard</h3>
          <label class="pill">Hero Title</label>
          <input id="homeTitle" type="text" placeholder="e.g., My Journey in Control Engineering">
          <label class="pill">Hero Subtitle</label>
          <input id="homeSubtitle" type="text" placeholder="e.g., Building toward wave impedance haptics">
          <label class="pill">About</label>
          <textarea id="homeAbout" placeholder="Short summary about your research and interests..."></textarea>
          <div class="row">
            <button class="btn primary" id="saveHome">Save Home</button>
            <span class="muted" id="homeSaved"></span>
          </div>
        </div>

        <div class="card">
          <h3>Files (local folder)</h3>
          <div class="row">
            <input type="file" id="filePicker" multiple class="btn">
            <button class="btn" id="clearFiles">Clear All</button>
          </div>
          <div id="fileList" style="margin-top:10px;display:grid;gap:8px"></div>
          <p class="muted">Files are stored locally (IndexedDB). To share publicly, upload to GitHub or Supabase Storage and link in a post.</p>
        </div>

        <div class="card">
          <h3>Posts</h3>
          <p class="muted">Public feed from Supabase (anyone can view). Sign in to create a post.</p>
          <div id="postList" class="grid" style="gap:10px"></div>

          <div id="newPost" class="card hidden" style="margin-top:12px">
            <h3>New Post</h3>
            <input id="pTitle" type="text" placeholder="Title">
            <textarea id="pBody" placeholder="Markdown content..."></textarea>
            <input id="pImage" type="file" accept="image/*">
            <div class="row">
              <button class="btn primary" id="publish">Publish</button>
            </div>
            <div class="muted" id="pubMsg"></div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div>
        <div class="card">
          <h3>Notes</h3>
          <p class="muted">Quick notes saved locally (private).</p>
          <textarea id="homeNotes" placeholder="Write your study notes..."></textarea>
        </div>
      </div>
    </div>
  </section>

  <!-- LEARNINGS (Supabase-backed) -->
  <section id="learnings" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2>Learnings (Notebook) <span id="pubBadge" class="badge">Public</span></h2>
      <div class="row" style="gap:8px">
        <button class="btn" data-cmd="bold"><b>B</b></button>
        <button class="btn" data-cmd="italic"><i>I</i></button>
        <button class="btn" data-cmd="underline"><u>U</u></button>
        <button class="btn" id="h1">H1</button>
        <button class="btn" id="h2">H2</button>
        <button class="btn" id="bul">• List</button>
        <button class="btn" id="img">Insert Image</button>
        <button class="btn primary" id="saveNote">Save</button>
        <button class="btn" id="togglePublic" style="display:none">Make Public</button>
        <span id="noteStatus" class="muted">Not signed in</span>
        <label class="pill" style="cursor:pointer">
          <input type="checkbox" id="autoSaveToggle" style="margin-right:6px"> Auto-save
        </label>
      </div>
    </div>
    <p class="muted">Public can read when visible; only you (signed in) can edit.</p>
    <div id="editor" class="editor" contenteditable="true"></div>
  </section>

  <!-- CHECKLIST -->
  <section id="checklist" class="card hidden">
    <h2>Checklist</h2>
    <p class="muted">Track key topics to master for your research plan. Your progress is saved.</p>
    <div id="checkContainer" class="grid" style="gap:10px"></div>
    <div class="row" style="margin-top:10px">
      <input id="newItem" type="text" placeholder="Add a custom checklist item...">
      <button class="btn" id="addItem">Add</button>
      <button class="btn" id="resetChecklist">Reset Defaults</button>
    </div>
  </section>

  <!-- PROF. KATSURA -->
  <section id="prof" class="card hidden">
    <h2>Prof. Katsura — Lab & Papers</h2>
    <p class="muted">Quick access to laboratory websites and selected publications relevant to your topic.</p>
    <div class="grid" id="profLinks" style="gap:8px"></div>
    <div class="card" style="margin-top:16px">
      <h3>Add Link</h3>
      <div class="row">
        <input id="linkTitle" type="text" placeholder="Title (e.g., Wave Dynamics paper)">
        <input id="linkURL" type="url" placeholder="https://...">
        <button class="btn" id="addLink">Add</button>
      </div>
    </div>
  </section>

  <!-- MODELS -->
  <section id="models" class="card hidden">
    <h2>Models & Demos</h2>
    <p class="muted">Register simulations, code repos, or small demos. Paste links to GitHub, Colab, or upload small assets.</p>
    <div id="modelList" class="grid" style="gap:8px"></div>
    <div class="card" style="margin-top:16px">
      <h3>Add Model</h3>
      <div class="grid two">
        <input id="modelTitle" type="text" placeholder="e.g., MCS Python Simulation">
        <input id="modelURL" type="url" placeholder="https://github.com/... or local file link">
      </div>
      <textarea id="modelDesc" placeholder="Short description (what it shows, key metrics, how it ties to wave impedance)..."></textarea>
      <div class="row">
        <button class="btn" id="addModel">Add Model</button>
      </div>
    </div>
  </section>

  <!-- ARTICLES -->
  <section id="articles" class="card hidden">
    <h2>Articles & Papers (Related Work)</h2>
    <p class="muted">Collect papers related to wave impedance control, bilateral teleoperation, disturbance observers, and haptics.</p>
    <div id="articleList" class="grid" style="gap:8px"></div>
    <div class="card" style="margin-top:16px">
      <h3>Add Article</h3>
      <div class="grid two">
        <input id="articleTitle" type="text" placeholder="Paper title">
        <input id="articleURL" type="url" placeholder="https://doi.org/... or publisher link">
      </div>
      <textarea id="articleNotes" placeholder="Why is this relevant to your plan? Key insight or quote (paraphrase)."></textarea>
      <div class="row">
        <button class="btn" id="addArticle">Add Article</button>
      </div>
    </div>
  </section>
</main>

<footer>
  Local notes & files are private in your browser. Public posts & images come from Supabase. Learnings are public-read / owner-edit via Supabase.
</footer>

<script>
// ---------- Tabs ----------
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>t.addEventListener('click', ()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(t.dataset.tab).classList.remove('hidden');
  localStorage.setItem('activeTab', t.dataset.tab);
}));
const savedTab = localStorage.getItem('activeTab');
if(savedTab){ tabs.forEach(t=>{ if(t.dataset.tab===savedTab){ t.click(); }}); }

// ---------- Home: text fields ----------
const homeTitle = document.getElementById('homeTitle');
const homeSubtitle = document.getElementById('homeSubtitle');
const homeAbout = document.getElementById('homeAbout');
const homeSaved = document.getElementById('homeSaved');
const homeNotes = document.getElementById('homeNotes');
function loadHome(){
  homeTitle.value = localStorage.getItem('homeTitle') || "My Journey in Control Engineering";
  homeSubtitle.value = localStorage.getItem('homeSubtitle') || "Building toward wave impedance-based haptics for VR and teleoperation";
  homeAbout.value = localStorage.getItem('homeAbout') || "This space collects my learnings, code, and experiments aligned with Prof. Katsura’s research themes.";
  homeNotes.value = localStorage.getItem('homeNotes') || "";
}
document.getElementById('saveHome').onclick = ()=>{
  localStorage.setItem('homeTitle', homeTitle.value);
  localStorage.setItem('homeSubtitle', homeSubtitle.value);
  localStorage.setItem('homeAbout', homeAbout.value);
  homeSaved.textContent = "Saved ✓";
  setTimeout(()=>homeSaved.textContent="",1200);
};
homeNotes.addEventListener('input', ()=> localStorage.setItem('homeNotes', homeNotes.value));
loadHome();

// ---------- IndexedDB Files ----------
let db;
const DB_NAME = 'portfolioFilesDB';
const STORE = 'files';
const fileList = document.getElementById('fileList');
function initDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = e=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE,{keyPath:'id', autoIncrement:true});
      }
    };
    req.onsuccess = e=>{ db=e.target.result; resolve(); };
    req.onerror = e=>reject(e);
  });
}
function addFiles(files){
  const tx = db.transaction(STORE,'readwrite');
  const store = tx.objectStore(STORE);
  Array.from(files).forEach(f=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      store.add({name:f.name, type:f.type, size:f.size, data:reader.result, ts:Date.now()});
      tx.oncomplete = renderFiles;
    };
    reader.readAsArrayBuffer(f);
  });
}
function renderFiles(){
  const tx = db.transaction(STORE,'readonly');
  const store = tx.objectStore(STORE);
  const req = store.getAll();
  req.onsuccess = ()=>{
    const items = req.result.sort((a,b)=>b.ts-a.ts);
    fileList.innerHTML = "";
    items.forEach(item=>{
      const url = URL.createObjectURL(new Blob([item.data], {type:item.type||'application/octet-stream'}));
      const div = document.createElement('div');
      div.className = 'file';
      const left = document.createElement('div');
      left.innerHTML = `<b>${item.name}</b> <i>(${Math.round(item.size/1024)} KB)</i>`;
      const right = document.createElement('div');
      const a = document.createElement('a');
      a.href = url; a.download = item.name; a.textContent = 'Download';
      a.style.marginRight='8px';
      const del = document.createElement('button');
      del.className='btn danger'; del.textContent='Remove';
      del.onclick = ()=>{
        const tx2 = db.transaction(STORE,'readwrite');
        tx2.objectStore(STORE).delete(item.id);
        tx2.oncomplete = renderFiles;
      };
      right.appendChild(a); right.appendChild(del);
      div.appendChild(left); div.appendChild(right);
      fileList.appendChild(div);
    });
  };
}
document.getElementById('filePicker').addEventListener('change', e=> addFiles(e.target.files));
document.getElementById('clearFiles').onclick = ()=>{
  const tx = db.transaction(STORE,'readwrite');
  tx.objectStore(STORE).clear();
  tx.oncomplete = renderFiles;
};
initDB().then(renderFiles);
</script>

<!-- Supabase: Auth + Posts + Learnings + Storage -->
<script type="module">
  // ----------- Auth (GitHub) -----------
  const loginBtn  = document.getElementById('login');
  const logoutBtn = document.getElementById('logout');
  const newPostEl = document.getElementById('newPost');
  const RETURN_TO = "https://kav33sh.github.io/Kaveesh-Research-Portal/";

  supabase.auth.onAuthStateChange((_event, session) => {
    const loggedIn = !!session;
    loginBtn.style.display  = loggedIn ? 'none' : 'inline-block';
    logoutBtn.style.display = loggedIn ? 'inline-block' : 'none';
    newPostEl.classList.toggle('hidden', !loggedIn);
  });

  loginBtn.onclick = async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'github',
      options: { redirectTo: RETURN_TO }
    });
    if (error) { alert(`Login error: ${error.message}`); console.error(error); }
  };
  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    location.href = RETURN_TO;
  };

  // ----------- Posts (DB) -----------
  const postList = document.getElementById('postList');
  async function loadPosts(){
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at', { ascending: false });
    if(error){
      postList.innerHTML = "<div class='muted'>Failed to load posts.</div>";
      console.error(error); return;
    }
    postList.innerHTML = "";
    for(const p of data){
      const card = document.createElement('div');
      card.className = 'post';
      const title = p.title || "Post";
      const when = new Date(p.created_at).toLocaleString();
      const imgTag = p.image_url ? `<img src="${p.image_url}" alt="post image">` : "";
      const bodyHTML = window.marked ? marked.parse(p.body_md || "") : (p.body_md || "");
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${title}</div>
          <div class="muted" style="font-size:12px">${when}</div>
        </div>
        ${imgTag}
        <div class="post-body">${bodyHTML}</div>`;
      postList.appendChild(card);
    }
  }
  loadPosts();

  // ----------- Image Upload (Storage) -----------
  const BUCKET_NAME = "images"; // ensure this bucket exists & has policies
  async function uploadImage(file){
    if(!file) return null;
    const path = `posts/${Date.now()}_${file.name}`;
    const { error } = await supabase.storage.from(BUCKET_NAME).upload(path, file, { upsert:false });
    if(error){ console.error("Upload failed:", error.message); return null; }
    const { data: pub } = supabase.storage.from(BUCKET_NAME).getPublicUrl(path);
    return pub.publicUrl;
  }
  document.getElementById('publish').onclick = async ()=>{
    const title = document.getElementById('pTitle').value.trim();
    const body  = document.getElementById('pBody').value.trim();
    const file  = document.getElementById('pImage').files[0];
    const msg   = document.getElementById('pubMsg');
    if(!title || !body){ msg.textContent = "Title and content required."; return; }
    const { data: { user } } = await supabase.auth.getUser();
    if(!user){ msg.textContent = "Please sign in first."; return; }

    let image_url = null;
    if(file){
      image_url = await uploadImage(file);
      if(!image_url){ msg.textContent = "Image upload failed."; return; }
    }
    const { error } = await supabase.from('posts').insert({
      author: user.id, title, body_md: body, image_url
    });
    if(error){ msg.textContent = "Publish failed."; console.error(error); return; }
    msg.textContent = "Published ✓";
    document.getElementById('pTitle').value = "";
    document.getElementById('pBody').value  = "";
    document.getElementById('pImage').value = "";
    loadPosts();
  };

  // ----------- Learnings (Public read / Owner edit) -----------
  const editor       = document.getElementById('editor');
  const saveBtn      = document.getElementById('saveNote');
  const noteStatus   = document.getElementById('noteStatus');
  const autoSaveTgl  = document.getElementById('autoSaveToggle');
  const toggleBtn    = document.getElementById('togglePublic');
  const pubBadge     = document.getElementById('pubBadge');

  // formatting
  document.querySelectorAll('[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=> document.execCommand(btn.dataset.cmd,false,null));
  });
  document.getElementById('h1').onclick = ()=> document.execCommand('formatBlock', false, 'h1');
  document.getElementById('h2').onclick = ()=> document.execCommand('formatBlock', false, 'h2');
  document.getElementById('bul').onclick = ()=> document.execCommand('insertUnorderedList', false, null);
  document.getElementById('img').onclick = ()=>{
    const input = document.createElement('input'); input.type='file'; input.accept='image/*';
    input.onchange = e=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=> document.execCommand('insertImage', false, r.result);
      r.readAsDataURL(f);
    };
    input.click();
  };

  function defaultWelcomeHTML(){
    return `<h2>Learnings</h2>
    <p>This notebook is <b>publicly readable</b> when marked public. Sign in to edit and auto-save.</p>
    <ul>
      <li>Summaries of Katsura Lab papers</li>
      <li>Experiments toward wave-impedance haptics</li>
      <li>Images are embedded inline</li>
    </ul>`;
  }

  function debounce(fn, ms=600){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const debouncedSave = debounce(async ()=>{ if(autoSaveTgl.checked){ await saveNote(); } }, 800);

  async function loadPublicNote(){
    noteStatus.textContent = "Loading public note…";
    const { data, error } = await supabase
      .from('notes')
      .select('content, updated_at')
      .eq('is_public', true)
      .order('updated_at', { ascending: false })
      .limit(1)
      .maybeSingle();
    if(error){
      console.error("Public note load error:", error);
      editor.innerHTML = defaultWelcomeHTML();
      noteStatus.textContent = "Public note load failed";
      pubBadge.textContent = "Public";
      editor.setAttribute('contenteditable','false');
      saveBtn.disabled = true; autoSaveTgl.disabled = true; toggleBtn.style.display='none';
      return;
    }
    const html = data?.content || defaultWelcomeHTML();
    editor.innerHTML = html;
    noteStatus.textContent = "Public (read-only)";
    pubBadge.textContent = "Public";
    editor.setAttribute('contenteditable','false');
    saveBtn.disabled = true; autoSaveTgl.disabled = true; toggleBtn.style.display='none';
  }

  async function loadOwnNote(userId){
    noteStatus.textContent = "Loading your note…";
    const { data, error } = await supabase
      .from('notes')
      .select('content, is_public')
      .eq('user_id', userId)
      .maybeSingle();
    if(error){ console.error("Own note load error:", error); noteStatus.textContent = "Load failed"; return; }
    const html = data?.content || defaultWelcomeHTML();
    editor.innerHTML = html;
    editor.setAttribute('contenteditable','true');
    saveBtn.disabled = false; autoSaveTgl.disabled = false;
    toggleBtn.style.display='inline-block';
    const isPublic = !!data?.is_public;
    pubBadge.textContent = isPublic ? "Public" : "Private";
    toggleBtn.textContent = isPublic ? "Make Private" : "Make Public";
    noteStatus.textContent = isPublic ? "Loaded (public ✓)" : "Loaded (private)";
  }

  async function saveNote(){
  const { data: { user }, error: userErr } = await supabase.auth.getUser();
  if (userErr) {
    console.error("Auth getUser error:", userErr);
    noteStatus.textContent = "Save failed (auth)";
    return;
  }
  if(!user){ noteStatus.textContent = "Sign in to save"; return; }

  noteStatus.textContent = "Saving…";
  const html = editor.innerHTML;

  const { error } = await supabase
    .from('notes')
    .upsert(
      { user_id: user.id, content: html },   // include user_id to satisfy RLS
      { onConflict: 'user_id' }              // use your unique constraint
    );

  if (error) {
    console.error("Save note DB error:", error);
    noteStatus.textContent = "Save failed";
  } else {
    noteStatus.textContent = "Saved ✓";
  }
}

  async function refreshToggleUI(userId){
    const { data, error } = await supabase
      .from('notes')
      .select('is_public')
      .eq('user_id', userId)
      .maybeSingle();
    const isPublic = !!data?.is_public;
    pubBadge.textContent = isPublic ? "Public" : "Private";
    toggleBtn.textContent = isPublic ? "Make Private" : "Make Public";
    noteStatus.textContent = isPublic ? "Loaded (public ✓)" : "Loaded (private)";
  }

  toggleBtn.addEventListener('click', async ()=>{
    const { data: { user } } = await supabase.auth.getUser();
    if(!user){ alert("Sign in first."); return; }
    // Ensure a row exists, then flip flag
    await supabase.from('notes').upsert({ user_id: user.id, content: editor.innerHTML }).eq('user_id', user.id);
    const { data, error } = await supabase
      .from('notes').select('is_public').eq('user_id', user.id).maybeSingle();
    const next = !(data?.is_public);
    const { error: updErr } = await supabase.from('notes').update({ is_public: next }).eq('user_id', user.id);
    if(updErr){ console.error(updErr); alert("Failed to toggle"); return; }
    await refreshToggleUI(user.id);
  });

  editor.addEventListener('input', debouncedSave);
  document.getElementById('saveNote').addEventListener('click', saveNote);
  autoSaveTgl.checked = localStorage.getItem('autoSaveLearnings') === '1';
  autoSaveTgl.onchange = ()=> localStorage.setItem('autoSaveLearnings', autoSaveTgl.checked?'1':'0');

  // Initial load depending on auth
  (async ()=>{
    const { data: { user } } = await supabase.auth.getUser();
    if(user){ await loadOwnNote(user.id); }
    else { await loadPublicNote(); }
  })();

  // React to future auth changes
  supabase.auth.onAuthStateChange(async (_evt, session)=>{
    if(session?.user){ await loadOwnNote(session.user.id); }
    else { await loadPublicNote(); }
  });
</script>
</body>
</html>
